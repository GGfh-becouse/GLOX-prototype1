<script>
    // ========== –ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê –û–ü–†–û–°–û–í ==========
    const wellBeingQuiz = {
        categories: [
            { 
                id: 'sleep', 
                name: '–°–û–ù', 
                icon: 'üò¥',
                x: 0, 
                y: 0,
                questions: [
                    '–ö–∞–∫ –≤—ã —Å–ø–∞–ª–∏ –ø—Ä–æ—à–ª–æ–π –Ω–æ—á—å—é?',
                    '–ß—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã —Å–µ–±—è –æ—Ç–¥–æ—Ö–Ω—É–≤—à–∏–º?',
                    '–ë—ã–ª–∏ –ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞—Å—ã–ø–∞–Ω–∏–µ–º?'
                ]
            },
            { 
                id: 'mood', 
                name: '–ù–ê–°–¢–†–û–ï–ù–ò–ï', 
                icon: 'üòä',
                x: 0, 
                y: 0,
                questions: [
                    '–ö–∞–∫–æ–µ —É –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–π—á–∞—Å?',
                    '–ß—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã —Ä–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å?',
                    '–ï—Å—Ç—å –ª–∏ –º–æ—Ç–∏–≤–∞—Ü–∏—è —á—Ç–æ-—Ç–æ –¥–µ–ª–∞—Ç—å?'
                ]
            },
            { 
                id: 'physical', 
                name: '–§–ò–ó–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï', 
                icon: 'üí™',
                x: 0, 
                y: 0,
                questions: [
                    '–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ —Å–≤–æ–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ?',
                    '–ï—Å—Ç—å –ª–∏ –±–æ–ª—å –∏–ª–∏ –¥–∏—Å–∫–æ–º—Ñ–æ—Ä—Ç?',
                    '–ß—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã –ø—Ä–∏–ª–∏–≤ —ç–Ω–µ—Ä–≥–∏–∏?'
                ]
            }
        ],
        
        recommendations: {
            perfect: {
                title: "–ò–î–ï–ê–õ–¨–ù–û!",
                emoji: "üåü",
                minScore: 12,
                tips: [
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ—é —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á",
                    "–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Ö–æ—Ä–æ—à–∏–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º —Å –¥—Ä—É–≥–∏–º–∏",
                    "–ó–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –Ω–∞ –≤–µ—á–µ—Ä",
                    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–æ–≤–æ–µ —Ö–æ–±–±–∏"
                ]
            },
            good: {
                title: "–•–û–†–û–®–û",
                emoji: "üòä",
                minScore: 9,
                tips: [
                    "–°–æ—Å—Ç–∞–≤—å—Ç–µ –ø–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å",
                    "–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å",
                    "–°–¥–µ–ª–∞–π—Ç–µ –Ω–µ–±–æ–ª—å—à—É—é –ø—Ä–æ–≥—É–ª–∫—É",
                    "–ü–æ–æ–±—â–∞–π—Ç–µ—Å—å —Å –±–ª–∏–∑–∫–∏–º–∏"
                ]
            },
            normal: {
                title: "–ù–û–†–ú–ê–õ–¨–ù–û",
                emoji: "üôÇ",
                minScore: 6,
                tips: [
                    "–ù–∞—á–Ω–∏—Ç–µ —Å –ª—ë–≥–∫–∏—Ö –∑–∞–¥–∞—á",
                    "–°–¥–µ–ª–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–µ—Ä—ã–≤",
                    "–ü–æ—Å–ª—É—à–∞–π—Ç–µ –ª—é–±–∏–º—É—é –º—É–∑—ã–∫—É",
                    "–í—ã–ø–µ–π—Ç–µ —Ç—Ä–∞–≤—è–Ω–æ–π —á–∞–π"
                ]
            },
            low: {
                title: "–¢–†–ï–í–û–ñ–ù–û",
                emoji: "üòî",
                minScore: 0,
                tips: [
                    "–û—Ç–¥–æ—Ö–Ω–∏—Ç–µ 15-20 –º–∏–Ω—É—Ç",
                    "–í—ã–ø–µ–π—Ç–µ —Ç—Ä–∞–≤—è–Ω–æ–π —á–∞–π",
                    "–°–¥–µ–ª–∞–π—Ç–µ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è",
                    "–ü–æ–≥–æ–≤–æ—Ä–∏—Ç–µ —Å –∫–µ–º-—Ç–æ –±–ª–∏–∑–∫–∏–º"
                ]
            }
        },
        
        calculateTotalScore() {
            let totalX = 0, totalY = 0;
            this.categories.forEach(cat => {
                totalX += cat.x;
                totalY += cat.y;
            });
            return ((totalX + totalY) / 6 * 15).toFixed(1);
        },
        
        getResultByScore(score) {
            const numScore = parseFloat(score);
            if (numScore >= 12) return this.recommendations.perfect;
            if (numScore >= 9) return this.recommendations.good;
            if (numScore >= 6) return this.recommendations.normal;
            return this.recommendations.low;
        },
        
        getColorForValue(value) {
            const colors = ['#F44336', '#FF5722', '#FFC107', '#8BC34A', '#4CAF50'];
            const index = Math.floor((value + 5) / 2.5);
            return colors[Math.min(4, Math.max(0, index))];
        }
    };

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let currentCategoryIndex = 0;
    let lastQuizResult = null;

    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏–¥–∂–µ—Ç–æ–≤
    const appData = {
        activeWidgets: ['tasks', 'worldTime', 'recommendations', 'psychological'],
        availableWidgets: [
            { id: 'tasks', name: '–ó–∞–¥–∞—á–∏', icon: 'fas fa-tasks', description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏' },
            { id: 'worldTime', name: '–ú–∏—Ä–æ–≤–æ–µ –≤—Ä–µ–º—è', icon: 'fas fa-globe', description: '–í—Ä–µ–º—è –≤ —Ä–∞–∑–Ω—ã—Ö –≥–æ—Ä–æ–¥–∞—Ö' },
            { id: 'recommendations', name: '–°–æ–≤–µ—Ç—ã GLOX', icon: 'fas fa-lightbulb', description: '–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏' },
            { id: 'psychological', name: '–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ', icon: 'fas fa-brain', description: '–û—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –º–µ—Ç—Ä–∏–∫–∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏' }
        ],
        tasks: [
            { id: 1, text: '–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è –≤ GLOX', completed: false },
            { id: 2, text: '–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∏–¥–∂–µ—Ç—ã –ø–æ–¥ —Å–≤–æ–∏ –Ω—É–∂–¥—ã', completed: false },
            { id: 3, text: '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É', completed: false }
        ],
        recommendations: [
            { title: '–ù–∞—á–Ω–∏—Ç–µ –¥–µ–Ω—å —Å —Ç–µ—Å—Ç–∞ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è', description: '–ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', icon: 'fas fa-heartbeat' },
            { title: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç—ë–º–Ω—É—é —Ç–µ–º—É –≤–µ—á–µ—Ä–æ–º', description: '–î–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –≥–ª–∞–∑–∞', icon: 'fas fa-moon' },
            { title: '–§–∏–ª–æ—Å–æ—Ñ–∏—è GLOX', description: '–ü–æ–º–Ω–∏—Ç–µ: –≤—Å—ë —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ ‚Äî –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç', icon: 'fas fa-brain' }
        ]
    };

    // ========== –í–ò–î–ñ–ï–¢ –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–û–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø ==========
    const gloxSessionState = {
        sessionId: 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        startedAt: null,
        finishedAt: null,
        
        baseCoordinates: {
            x: 0,
            y: 0
        },
        
        surveys: [
            {
                surveyId: 'sleep_survey',
                topic: '–°–æ–Ω –∏ –æ—Ç–¥—ã—Ö',
                questions: [
                    { questionId: 'sleep_1', questionText: '–ö–∞–∫ –≤—ã —Å–ø–∞–ª–∏ –ø—Ä–æ—à–ª–æ–π –Ω–æ—á—å—é?', answersHistory: [], finalValue: null, changesCount: 0 },
                    { questionId: 'sleep_2', questionText: '–ß—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã —Å–µ–±—è –æ—Ç–¥–æ—Ö–Ω—É–≤—à–∏–º?', answersHistory: [], finalValue: null, changesCount: 0 },
                    { questionId: 'sleep_3', questionText: '–ë—ã–ª–∏ –ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞—Å—ã–ø–∞–Ω–∏–µ–º?', answersHistory: [], finalValue: null, changesCount: 0 }
                ],
                startedAt: null,
                finishedAt: null
            },
            {
                surveyId: 'anxiety_survey',
                topic: '–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å',
                questions: [
                    { questionId: 'anxiety_1', questionText: '–ß—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã –±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ?', answersHistory: [], finalValue: null, changesCount: 0 },
                    { questionId: 'anxiety_2', questionText: '–ö–∞–∫ —á–∞—Å—Ç–æ –≤—ã –¥—É–º–∞–µ—Ç–µ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö?', answersHistory: [], finalValue: null, changesCount: 0 }
                ],
                startedAt: null,
                finishedAt: null
            },
            {
                surveyId: 'energy_survey',
                topic: '–≠–Ω–µ—Ä–≥–∏—è –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—è',
                questions: [
                    { questionId: 'energy_1', questionText: '–ß—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã –ø—Ä–∏–ª–∏–≤ —Å–∏–ª?', answersHistory: [], finalValue: null, changesCount: 0 },
                    { questionId: 'energy_2', questionText: '–ï—Å—Ç—å –ª–∏ –º–æ—Ç–∏–≤–∞—Ü–∏—è —á—Ç–æ-—Ç–æ –¥–µ–ª–∞—Ç—å?', answersHistory: [], finalValue: null, changesCount: 0 }
                ],
                startedAt: null,
                finishedAt: null
            }
        ],
        
        metrics: {
            confidence: 0,
            instability: 0,
            clarificationDepth: 0
        }
    };

    const questionsConfig = {
        sleep_1: { options: [
            { value: -2, label: 'üò¥ –û—á–µ–Ω—å –ø–ª–æ—Ö–æ', impact: { xDelta: -2, yDelta: -1 } },
            { value: -1, label: 'üòû –ü–ª–æ—Ö–æ', impact: { xDelta: -1, yDelta: 0 } },
            { value: 0, label: 'üòê –ù–æ—Ä–º–∞–ª—å–Ω–æ', impact: { xDelta: 0, yDelta: 0 } },
            { value: 1, label: 'üôÇ –•–æ—Ä–æ—à–æ', impact: { xDelta: 1, yDelta: 0.5 } },
            { value: 2, label: 'üòä –û—Ç–ª–∏—á–Ω–æ', impact: { xDelta: 2, yDelta: 1 } }
        ]},
        sleep_2: { options: [
            { value: -2, label: 'üò¥ –°–æ–≤—Å–µ–º –Ω–µ—Ç', impact: { xDelta: -1, yDelta: -2 } },
            { value: -1, label: 'üòû –ù–µ–º–Ω–æ–≥–æ', impact: { xDelta: 0, yDelta: -1 } },
            { value: 0, label: 'üòê –°—Ä–µ–¥–Ω–µ', impact: { xDelta: 0, yDelta: 0 } },
            { value: 1, label: 'üôÇ –•–æ—Ä–æ—à–æ', impact: { xDelta: 0.5, yDelta: 1 } },
            { value: 2, label: 'üòä –û—Ç–ª–∏—á–Ω–æ', impact: { xDelta: 1, yDelta: 2 } }
        ]},
        sleep_3: { options: [
            { value: -2, label: 'üòû –ß–∞—Å—Ç–æ', impact: { xDelta: -1, yDelta: -1 } },
            { value: -1, label: 'üòê –ò–Ω–æ–≥–¥–∞', impact: { xDelta: -0.5, yDelta: 0 } },
            { value: 1, label: 'üôÇ –†–µ–¥–∫–æ', impact: { xDelta: 0.5, yDelta: 0.5 } },
            { value: 2, label: 'üòä –ù–∏–∫–æ–≥–¥–∞', impact: { xDelta: 1, yDelta: 1 } }
        ]},
        anxiety_1: { options: [
            { value: -2, label: 'üò∞ –°–∏–ª—å–Ω–æ–µ', impact: { xDelta: -2, yDelta: -1 } },
            { value: -1, label: 'üòü –£–º–µ—Ä–µ–Ω–Ω–æ–µ', impact: { xDelta: -1, yDelta: 0 } },
            { value: 0, label: 'üòê –°–ª–∞–±–æ–µ', impact: { xDelta: 0, yDelta: 0 } },
            { value: 1, label: 'üôÇ –ù–µ—Ç', impact: { xDelta: 1, yDelta: 0.5 } }
        ]},
        anxiety_2: { options: [
            { value: -2, label: 'üò∞ –ü–æ—Å—Ç–æ—è–Ω–Ω–æ', impact: { xDelta: -2, yDelta: -1 } },
            { value: -1, label: 'üòü –ß–∞—Å—Ç–æ', impact: { xDelta: -1, yDelta: -0.5 } },
            { value: 0, label: 'üòê –ò–Ω–æ–≥–¥–∞', impact: { xDelta: 0, yDelta: 0 } },
            { value: 1, label: 'üôÇ –†–µ–¥–∫–æ', impact: { xDelta: 0.5, yDelta: 0.5 } }
        ]},
        energy_1: { options: [
            { value: -2, label: 'üò¥ –ù–µ—Ç —Å–∏–ª', impact: { xDelta: -1, yDelta: -2 } },
            { value: -1, label: 'üòû –ú–∞–ª–æ', impact: { xDelta: 0, yDelta: -1 } },
            { value: 0, label: 'üòê –°—Ä–µ–¥–Ω–µ', impact: { xDelta: 0, yDelta: 0 } },
            { value: 1, label: 'üôÇ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ', impact: { xDelta: 0.5, yDelta: 1 } },
            { value: 2, label: '‚ö° –ú–Ω–æ–≥–æ', impact: { xDelta: 1, yDelta: 2 } }
        ]},
        energy_2: { options: [
            { value: -2, label: 'üòû –ù–µ—Ç', impact: { xDelta: -1, yDelta: -1 } },
            { value: -1, label: 'üòê –°–ª–∞–±–∞—è', impact: { xDelta: -0.5, yDelta: 0 } },
            { value: 1, label: 'üôÇ –ï—Å—Ç—å', impact: { xDelta: 0.5, yDelta: 0.5 } },
            { value: 2, label: '‚ö° –°–∏–ª—å–Ω–∞—è', impact: { xDelta: 1, yDelta: 1 } }
        ]}
    };

    let psychCurrentStep = 'base';
    let psychCurrentSurveyIndex = 0;
    let psychCurrentQuestionIndex = 0;

    // ========== –§–£–ù–ö–¶–ò–ò –¢–ï–ú–´ ==========
    function initTheme() {
        const darkBtn = document.getElementById('darkThemeBtn');
        const lightBtn = document.getElementById('lightThemeBtn');
        
        const savedTheme = localStorage.getItem('gloxTheme') || 'dark';
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
            darkBtn.classList.remove('active');
            lightBtn.classList.add('active');
        }
        
        darkBtn.addEventListener('click', () => {
            document.body.classList.remove('light-theme');
            darkBtn.classList.add('active');
            lightBtn.classList.remove('active');
            localStorage.setItem('gloxTheme', 'dark');
        });
        
        lightBtn.addEventListener('click', () => {
            document.body.classList.add('light-theme');
            lightBtn.classList.add('active');
            darkBtn.classList.remove('active');
            localStorage.setItem('gloxTheme', 'light');
        });
    }

    // ========== –§–£–ù–ö–¶–ò–ò –û–ü–†–û–°–ù–ò–ö–ê ==========
    function renderCurrentCategory() {
        const container = document.getElementById('quizContent');
        container.innerHTML = '';
        
        const category = wellBeingQuiz.categories[currentCategoryIndex];
        
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'quiz-category';
        
        const header = document.createElement('div');
        header.className = 'category-header';
        header.innerHTML = `
            <div class="category-icon">${category.icon}</div>
            <div class="category-title">${category.name}</div>
        `;
        categoryDiv.appendChild(header);
        
        const grid = createCoordinateGrid(category);
        categoryDiv.appendChild(grid);
        
        const sliders = createSliders(category);
        categoryDiv.appendChild(sliders);
        
        container.appendChild(categoryDiv);
        
        updateNavigationButtons();
        updateProgress();
    }

    function createCoordinateGrid(category) {
        const gridSize = 250;
        const half = gridSize / 2;
        
        const gridDiv = document.createElement('div');
        gridDiv.className = 'coordinate-grid';
        
        const xAxis = document.createElement('div');
        xAxis.className = 'grid-axis grid-axis-x';
        const yAxis = document.createElement('div');
        yAxis.className = 'grid-axis grid-axis-y';
        
        const marker = document.createElement('div');
        marker.className = 'grid-marker';
        
        const labels = document.createElement('div');
        labels.className = 'grid-labels';
        labels.innerHTML = `
            <div style="position: absolute; top: 5px; left: 50%; transform: translateX(-50%);">üòä –•–æ—Ä–æ—à–æ</div>
            <div style="position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%);">üòû –ü–ª–æ—Ö–æ</div>
            <div style="position: absolute; left: 5px; top: 50%; transform: translateY(-50%);">üò¥ –¢—è–∂–µ–ª–æ</div>
            <div style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%);">‚ö° –õ–µ–≥–∫–æ</div>
        `;
        
        gridDiv.appendChild(xAxis);
        gridDiv.appendChild(yAxis);
        gridDiv.appendChild(labels);
        gridDiv.appendChild(marker);
        
        function updateMarkerPosition() {
            const left = half + (category.x / 5) * half;
            const top = half - (category.y / 5) * half;
            marker.style.left = `${Math.min(gridSize, Math.max(0, left))}px`;
            marker.style.top = `${Math.min(gridSize, Math.max(0, top))}px`;
            marker.style.background = wellBeingQuiz.getColorForValue((category.x + category.y) / 2);
        }
        
        gridDiv.addEventListener('click', (e) => {
            const rect = gridDiv.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            let newX = ((x / gridSize) * 10 - 5).toFixed(1);
            let newY = ((1 - y / gridSize) * 10 - 5).toFixed(1);
            
            newX = Math.min(5, Math.max(-5, parseFloat(newX)));
            newY = Math.min(5, Math.max(-5, parseFloat(newY)));
            
            category.x = newX;
            category.y = newY;
            
            updateMarkerPosition();
            updateCategoryDisplay(category);
            showClarifyingQuestion(category);
        });
        
        updateMarkerPosition();
        return gridDiv;
    }

    function createSliders(category) {
        const container = document.createElement('div');
        container.className = 'slider-container';
        
        const xSlider = createSliderItem('–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ', category.x, -5, 5, (value) => {
            category.x = value;
            updateCategoryDisplay(category);
            updateGridMarker(category);
        });
        
        const ySlider = createSliderItem('–≠–Ω–µ—Ä–≥–∏—è', category.y, -5, 5, (value) => {
            category.y = value;
            updateCategoryDisplay(category);
            updateGridMarker(category);
        });
        
        container.appendChild(xSlider);
        container.appendChild(ySlider);
        
        const valuesDiv = document.createElement('div');
        valuesDiv.className = 'category-values';
        container.appendChild(valuesDiv);
        
        const emojiDiv = document.createElement('div');
        emojiDiv.className = 'mood-emojis';
        container.appendChild(emojiDiv);
        
        updateCategoryDisplay(category);
        
        return container;
    }

    function createSliderItem(label, value, min, max, onChange) {
        const container = document.createElement('div');
        container.className = 'slider-item';
        
        const labelDiv = document.createElement('div');
        labelDiv.className = 'slider-label';
        labelDiv.innerHTML = `
            <span>${label}</span>
            <span class="slider-value">${value.toFixed(1)}</span>
        `;
        
        const input = document.createElement('input');
        input.type = 'range';
        input.min = min;
        input.max = max;
        input.step = 0.1;
        input.value = value;
        
        input.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            labelDiv.querySelector('.slider-value').textContent = val.toFixed(1);
            onChange(val);
        });
        
        container.appendChild(labelDiv);
        container.appendChild(input);
        
        return container;
    }

    function updateCategoryDisplay(category) {
        const container = document.querySelector('.quiz-category');
        if (!container) return;
        
        const valuesDiv = container.querySelector('.category-values');
        if (valuesDiv) {
            const xColor = wellBeingQuiz.getColorForValue(category.x);
            const yColor = wellBeingQuiz.getColorForValue(category.y);
            
            valuesDiv.innerHTML = `
                <div class="value-badge value-x" style="background: ${xColor}20; color: ${xColor};">
                    <i class="fas fa-heart"></i> ${category.x.toFixed(1)}
                </div>
                <div class="value-badge value-y" style="background: ${yColor}20; color: ${yColor};">
                    <i class="fas fa-bolt"></i> ${category.y.toFixed(1)}
                </div>
            `;
        }
        
        const emojiDiv = container.querySelector('.mood-emojis');
        if (emojiDiv) {
            const avgValue = (category.x + category.y) / 2;
            let moodEmoji = 'üòê';
            if (avgValue >= 3) moodEmoji = 'üòä';
            else if (avgValue >= 0) moodEmoji = 'üôÇ';
            else if (avgValue >= -3) moodEmoji = 'üòï';
            else moodEmoji = 'üòû';
            
            emojiDiv.innerHTML = `
                <span>${moodEmoji}</span>
                <span>${category.icon}</span>
                <span>${avgValue >= 0 ? 'üëç' : 'üëé'}</span>
            `;
        }
    }

    function updateGridMarker(category) {
        const grid = document.querySelector('.coordinate-grid');
        if (!grid) return;
        
        const marker = grid.querySelector('.grid-marker');
        const half = 125;
        const left = half + (category.x / 5) * half;
        const top = half - (category.y / 5) * half;
        
        marker.style.left = `${Math.min(250, Math.max(0, left))}px`;
        marker.style.top = `${Math.min(250, Math.max(0, top))}px`;
        marker.style.background = wellBeingQuiz.getColorForValue((category.x + category.y) / 2);
    }

    function showClarifyingQuestion(category) {
        const randomQuestion = category.questions[Math.floor(Math.random() * category.questions.length)];
        
        const questionDiv = document.createElement('div');
        questionDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid var(--primary);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1100;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: fadeIn 0.3s ease;
        `;
        
        questionDiv.innerHTML = `
            <h3 style="color: var(--primary); margin-bottom: 15px;">–£—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å</h3>
            <p style="font-size: 1.2rem; margin-bottom: 20px;">${randomQuestion}</p>
            <button class="quiz-btn" onclick="this.closest('div').remove()" style="margin: 0 auto;">–ü–æ–Ω—è—Ç–Ω–æ</button>
        `;
        
        document.body.appendChild(questionDiv);
        
        setTimeout(() => {
            if (questionDiv.parentNode) questionDiv.remove();
        }, 4000);
    }

    function updateNavigationButtons() {
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        prevBtn.disabled = currentCategoryIndex === 0;
        
        if (currentCategoryIndex === wellBeingQuiz.categories.length - 1) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        } else {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        }
        
        const allRated = wellBeingQuiz.categories.every(cat => cat.x !== 0 || cat.y !== 0);
        document.getElementById('completionIndicator').style.display = allRated ? 'flex' : 'none';
    }

    function updateProgress() {
        const progress = ((currentCategoryIndex + 1) / wellBeingQuiz.categories.length) * 100;
        document.getElementById('quizProgress').style.width = `${progress}%`;
    }

    function showResults() {
        const totalScore = wellBeingQuiz.calculateTotalScore();
        const result = wellBeingQuiz.getResultByScore(totalScore);
        
        document.getElementById('quizScreen').classList.remove('active');
        document.getElementById('resultsScreen').classList.add('active');
        
        document.getElementById('finalMoodEmoji').textContent = result.emoji;
        document.getElementById('finalScore').textContent = `${totalScore}/15`;
        
        const list = document.getElementById('recommendationsList');
        list.innerHTML = '';
        result.tips.forEach(tip => {
            const li = document.createElement('li');
            li.innerHTML = `<i class="fas fa-check-circle"></i> ${tip}`;
            list.appendChild(li);
        });
        
        const breakdown = document.getElementById('categoryBreakdown');
        breakdown.innerHTML = '<h4 style="color: var(--primary); margin-bottom: 10px;">–î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä:</h4>';
        
        wellBeingQuiz.categories.forEach(cat => {
            const avg = ((cat.x + cat.y) / 2).toFixed(1);
            const color = wellBeingQuiz.getColorForValue(parseFloat(avg));
            breakdown.innerHTML += `
                <div class="breakdown-item" style="background: ${color}10;">
                    <span>${cat.icon} ${cat.name}:</span>
                    <span style="color: ${color}; font-weight: bold;">${avg}</span>
                </div>
            `;
        });
        
        lastQuizResult = {
            score: totalScore,
            title: result.title,
            emoji: result.emoji
        };
    }

    function resetQuiz() {
        wellBeingQuiz.categories.forEach(cat => {
            cat.x = 0;
            cat.y = 0;
        });
        currentCategoryIndex = 0;
        
        document.getElementById('resultsScreen').classList.remove('active');
        document.getElementById('quizScreen').classList.remove('active');
        document.body.style.overflow = 'auto';
        
        document.getElementById('mainCircle').classList.remove('hidden');
        document.getElementById('resultCircle').classList.add('hidden');
    }

    function showResultCircle() {
        if (!lastQuizResult) return;
        
        document.getElementById('resultEmoji').textContent = lastQuizResult.emoji;
        document.getElementById('resultTitle').textContent = lastQuizResult.title;
        document.getElementById('resultScore').textContent = `${lastQuizResult.score}/15`;
        
        document.getElementById('mainCircle').classList.add('hidden');
        document.getElementById('resultCircle').classList.remove('hidden');
    }

    // ========== –§–£–ù–ö–¶–ò–ò –í–ò–î–ñ–ï–¢–û–í ==========
    function initTasksWidget() {
        const tasksContent = document.getElementById('tasksContent');
        
        function renderTasks() {
            tasksContent.innerHTML = '';
            appData.tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.style.cssText = 'display: flex; align-items: center; gap: 15px; padding: 12px; margin-bottom: 10px; background: rgba(255, 107, 53, 0.05); border-radius: 8px;';
                
                taskItem.innerHTML = `
                    <input type="checkbox" ${task.completed ? 'checked' : ''} 
                           style="width: 20px; height: 20px; cursor: pointer;">
                    <div style="flex: 1; ${task.completed ? 'text-decoration: line-through; color: var(--text-dim);' : ''}">
                        ${task.text}
                    </div>
                `;
                
                const checkbox = taskItem.querySelector('input');
                checkbox.addEventListener('change', function() {
                    task.completed = this.checked;
                    renderTasks();
                });
                
                tasksContent.appendChild(taskItem);
            });
        }
        
        document.querySelector('#tasksWidget .add-task-btn')?.addEventListener('click', function() {
            const taskText = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É:');
            if (taskText) {
                appData.tasks.push({
                    id: Date.now(),
                    text: taskText,
                    completed: false
                });
                renderTasks();
            }
        });
        
        renderTasks();
    }

    function initWorldTimeWidget() {
        function updateWorldTime() {
            const timeZones = [
                { city: '–ú–æ—Å–∫–≤–∞', offset: 3 },
                { city: '–õ–æ–Ω–¥–æ–Ω', offset: 0 },
                { city: '–ù—å—é-–ô–æ—Ä–∫', offset: -5 },
                { city: '–¢–æ–∫–∏–æ', offset: 9 }
            ];
            
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            
            let html = '';
            timeZones.forEach(zone => {
                const localTime = new Date(utc + (3600000 * zone.offset));
                const timeString = localTime.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
                
                html += `
                    <div class="time-zone">
                        <div class="time-city">${zone.city}</div>
                        <div class="time-display">${timeString}</div>
                        <div style="color: var(--text-dim); font-size: 0.9rem;">
                            GMT${zone.offset >= 0 ? '+' : ''}${zone.offset}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('worldTimeContent').innerHTML = html;
        }
        
        updateWorldTime();
        setInterval(updateWorldTime, 60000);
        
        document.querySelector('#worldTimeWidget .refresh-time-btn')?.addEventListener('click', updateWorldTime);
    }

    function initRecommendationsWidget() {
        const recContent = document.getElementById('recContent');
        
        function renderRecommendations() {
            recContent.innerHTML = '';
            appData.recommendations.forEach(rec => {
                const recCard = document.createElement('div');
                recCard.style.cssText = 'background: rgba(255, 107, 53, 0.05); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--theme-border); cursor: pointer;';
                recCard.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                        <div style="font-size: 1.5rem; color: var(--primary);">
                            <i class="${rec.icon}"></i>
                        </div>
                        <h4 style="color: var(--text-primary); margin: 0;">${rec.title}</h4>
                    </div>
                    <p style="color: var(--text-secondary); margin: 0;">${rec.description}</p>
                `;
                
                recCard.addEventListener('click', function() {
                    alert(`${rec.title}\n\n${rec.description}`);
                });
                
                recContent.appendChild(recCard);
            });
        }
        
        document.querySelector('#recWidget .refresh-btn')?.addEventListener('click', renderRecommendations);
        renderRecommendations();
    }

    function initWidgetManager() {
        const managerBtn = document.getElementById('addWidgetBtn');
        const manager = document.getElementById('widgetManager');
        const closeBtn = document.getElementById('closeManagerBtn');
        const availableWidgets = document.getElementById('availableWidgets');
        
        managerBtn.addEventListener('click', () => {
            manager.classList.add('active');
            document.body.style.overflow = 'hidden';
            renderAvailableWidgets();
        });
        
        closeBtn.addEventListener('click', () => {
            manager.classList.remove('active');
            document.body.style.overflow = 'auto';
        });
        
        function renderAvailableWidgets() {
            availableWidgets.innerHTML = '';
            appData.availableWidgets.forEach(widget => {
                const isActive = appData.activeWidgets.includes(widget.id);
                const widgetEl = document.createElement('div');
                widgetEl.className = 'widget-preview';
                widgetEl.innerHTML = `
                    <div style="font-size: 2rem; color: ${isActive ? 'var(--primary)' : 'var(--text-dim)'}; margin-bottom: 10px;">
                        <i class="${widget.icon}"></i>
                    </div>
                    <h4 style="color: ${isActive ? 'var(--text-primary)' : 'var(--text-dim)'}; margin-bottom: 5px;">
                        ${widget.name}
                    </h4>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">
                        ${widget.description}
                    </p>
                    <div style="color: ${isActive ? 'var(--primary)' : 'var(--text-dim)'};">
                        ${isActive ? '‚úì –ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ –∞–∫—Ç–∏–≤–µ–Ω'}
                    </div>
                `;
                
                widgetEl.addEventListener('click', () => {
                    const index = appData.activeWidgets.indexOf(widget.id);
                    if (index > -1) {
                        appData.activeWidgets.splice(index, 1);
                        document.getElementById(widget.id + 'Widget').style.display = 'none';
                    } else {
                        appData.activeWidgets.push(widget.id);
                        document.getElementById(widget.id + 'Widget').style.display = 'block';
                    }
                    renderAvailableWidgets();
                });
                
                availableWidgets.appendChild(widgetEl);
            });
        }
    }

    // ========== –§–£–ù–ö–¶–ò–ò –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–û–ì–û –í–ò–î–ñ–ï–¢–ê ==========
    function initPsychologicalWidget() {
        const startBtn = document.getElementById('startPsychologicalBtn');
        
        document.querySelector('#psychologicalWidget .close-btn')?.addEventListener('click', function() {
            document.getElementById('psychologicalWidget').style.display = 'none';
            const index = appData.activeWidgets.indexOf('psychological');
            if (index > -1) appData.activeWidgets.splice(index, 1);
        });
        
        startBtn?.addEventListener('click', startPsychSession);
        
        document.getElementById('psychPrevBtn').addEventListener('click', psychPrevStep);
        document.getElementById('psychNextBtn').addEventListener('click', psychNextStep);
        document.getElementById('psychSubmitBtn').addEventListener('click', psychCompleteSession);
        
        document.getElementById('closePsychResultsBtn').addEventListener('click', () => {
            document.getElementById('psychResultsScreen').classList.remove('active');
            document.body.style.overflow = 'auto';
            updatePsychWidgetDisplay();
        });
        
        document.getElementById('redoPsychQuizBtn').addEventListener('click', () => {
            document.getElementById('psychResultsScreen').classList.remove('active');
            startPsychSession();
        });
    }

    function startPsychSession() {
        gloxSessionState.startedAt = Date.now();
        gloxSessionState.finishedAt = null;
        gloxSessionState.baseCoordinates = { x: 0, y: 0 };
        
        gloxSessionState.surveys.forEach(survey => {
            survey.startedAt = null;
            survey.finishedAt = null;
            survey.questions.forEach(q => {
                q.answersHistory = [];
                q.finalValue = null;
                q.changesCount = 0;
            });
        });
        
        psychCurrentStep = 'base';
        document.getElementById('psychQuizScreen').classList.add('active');
        document.body.style.overflow = 'hidden';
        renderPsychBaseStep();
    }

    function renderPsychBaseStep() {
        const content = document.getElementById('psychQuizContent');
        document.getElementById('psychQuizSubtitle').textContent = '–ë–∞–∑–æ–≤–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞';
        
        content.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px;">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:
                </p>
            </div>
            
            <div style="margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>–°–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ (X)</span>
                    <span style="color: var(--primary);" id="baseXValue">0.0</span>
                </div>
                <input type="range" id="baseXSlider" min="-10" max="10" step="0.5" value="0" 
                       style="width: 100%; margin-bottom: 20px;">
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>–ù–∞–≥—Ä—É–∑–∫–∞/–ü–ª–∞–Ω—ã (Y)</span>
                    <span style="color: var(--primary);" id="baseYValue">0.0</span>
                </div>
                <input type="range" id="baseYSlider" min="-10" max="10" step="0.5" value="0" 
                       style="width: 100%;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;" class="psych-preview-grid">
                <div style="text-align: center; padding: 15px; background: rgba(255,107,53,0.05); border-radius: 8px;">
                    <div style="font-size: 2rem;">üòê</div>
                    <div style="color: var(--text-dim);">–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</div>
                </div>
                <div style="text-align: center; padding: 15px; background: rgba(255,107,53,0.05); border-radius: 8px;">
                    <div style="font-size: 2rem;">‚öñÔ∏è</div>
                    <div style="color: var(--text-dim);">–ë–∞–ª–∞–Ω—Å: 0.0</div>
                </div>
            </div>
        `;
        
        const xSlider = document.getElementById('baseXSlider');
        const ySlider = document.getElementById('baseYSlider');
        const xValue = document.getElementById('baseXValue');
        const yValue = document.getElementById('baseYValue');
        
        xSlider.addEventListener('input', () => {
            const val = parseFloat(xSlider.value);
            xValue.textContent = val.toFixed(1);
            gloxSessionState.baseCoordinates.x = val;
            updateBasePreview();
        });
        
        ySlider.addEventListener('input', () => {
            const val = parseFloat(ySlider.value);
            yValue.textContent = val.toFixed(1);
            gloxSessionState.baseCoordinates.y = val;
            updateBasePreview();
        });
        
        document.getElementById('psychPrevBtn').disabled = true;
        document.getElementById('psychNextBtn').style.display = 'block';
        document.getElementById('psychSubmitBtn').style.display = 'none';
    }

    function updateBasePreview() {
        const x = gloxSessionState.baseCoordinates.x;
        const y = gloxSessionState.baseCoordinates.y;
        const balance = Math.abs(x - y).toFixed(1);
        
        let moodEmoji = 'üòê';
        const avg = (x + y) / 2;
        if (avg >= 5) moodEmoji = 'üòä';
        else if (avg >= 2) moodEmoji = 'üôÇ';
        else if (avg >= -2) moodEmoji = 'üòê';
        else if (avg >= -5) moodEmoji = 'üòû';
        else moodEmoji = 'üò∞';
        
        const previewGrid = document.querySelector('.psych-preview-grid');
        if (previewGrid) {
            previewGrid.innerHTML = `
                <div style="text-align: center; padding: 15px; background: rgba(255,107,53,0.05); border-radius: 8px;">
                    <div style="font-size: 2rem;">${moodEmoji}</div>
                    <div style="color: var(--text-dim);">–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</div>
                </div>
                <div style="text-align: center; padding: 15px; background: rgba(255,107,53,0.05); border-radius: 8px;">
                    <div style="font-size: 2rem;">‚öñÔ∏è</div>
                    <div style="color: var(--text-dim);">–ë–∞–ª–∞–Ω—Å: ${balance}</div>
                </div>
            `;
        }
    }

    function psychNextStep() {
        if (psychCurrentStep === 'base') {
            psychCurrentStep = 'surveys';
            psychCurrentSurveyIndex = 0;
            psychCurrentQuestionIndex = 0;
            gloxSessionState.surveys[0].startedAt = Date.now();
            renderPsychQuestion();
        } else if (psychCurrentStep === 'surveys') {
            const currentSurvey = gloxSessionState.surveys[psychCurrentSurveyIndex];
            
            if (psychCurrentQuestionIndex < currentSurvey.questions.length - 1) {
                psychCurrentQuestionIndex++;
                renderPsychQuestion();
            } else {
                currentSurvey.finishedAt = Date.now();
                
                if (psychCurrentSurveyIndex < gloxSessionState.surveys.length - 1) {
                    psychCurrentSurveyIndex++;
                    psychCurrentQuestionIndex = 0;
                    gloxSessionState.surveys[psychCurrentSurveyIndex].startedAt = Date.now();
                    renderPsychQuestion();
                } else {
                    psychCompleteSession();
                }
            }
        }
    }

    function psychPrevStep() {
        if (psychCurrentStep === 'surveys') {
            if (psychCurrentQuestionIndex > 0) {
                psychCurrentQuestionIndex--;
                renderPsychQuestion();
            } else if (psychCurrentSurveyIndex > 0) {
                psychCurrentSurveyIndex--;
                const prevSurvey = gloxSessionState.surveys[psychCurrentSurveyIndex];
                psychCurrentQuestionIndex = prevSurvey.questions.length - 1;
                renderPsychQuestion();
            } else {
                psychCurrentStep = 'base';
                renderPsychBaseStep();
            }
        }
    }

    function renderPsychQuestion() {
        const survey = gloxSessionState.surveys[psychCurrentSurveyIndex];
        const question = survey.questions[psychCurrentQuestionIndex];
        const config = questionsConfig[question.questionId];
        
        document.getElementById('psychQuizSubtitle').textContent = survey.topic;
        
        const totalQuestions = gloxSessionState.surveys.reduce((acc, s) => acc + s.questions.length, 0);
        const currentQuestionNum = gloxSessionState.surveys
            .slice(0, psychCurrentSurveyIndex)
            .reduce((acc, s) => acc + s.questions.length, 0) + psychCurrentQuestionIndex + 1;
        const progress = (currentQuestionNum / totalQuestions) * 100;
        document.getElementById('psychQuizProgress').style.width = progress + '%';
        
        const content = document.getElementById('psychQuizContent');
        let optionsHtml = '';
        
        config.options.forEach(option => {
            const isSelected = question.finalValue === option.value;
            optionsHtml += `
                <div class="quiz-option psych-option" data-value="${option.value}" 
                     data-impact='${JSON.stringify(option.impact)}'
                     style="${isSelected ? 'background: rgba(255,107,53,0.3); border-color: var(--primary);' : ''}">
                    ${option.label}
                </div>
            `;
        });
        
        content.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 style="color: var(--text-primary); margin-bottom: 10px;">${question.questionText}</h3>
                <p style="color: var(--text-dim); font-size: 0.9rem;">
                    –ò–∑–º–µ–Ω–µ–Ω–∏–π: ${question.changesCount}
                </p>
            </div>
            
            <div class="quiz-options" style="margin-bottom: 20px;">
                ${optionsHtml}
            </div>
        `;
        
        document.querySelectorAll('.psych-option').forEach(opt => {
            opt.addEventListener('click', function() {
                const value = parseInt(this.dataset.value);
                const impact = JSON.parse(this.dataset.impact);
                
                document.querySelectorAll('.psych-option').forEach(o => {
                    o.style.background = 'rgba(255, 107, 53, 0.1)';
                    o.style.borderColor = 'rgba(255, 107, 53, 0.2)';
                });
                
                this.style.background = 'rgba(255, 107, 53, 0.3)';
                this.style.borderColor = 'var(--primary)';
                
                question.answersHistory.push({
                    value: value,
                    impact: impact,
                    timestamp: Date.now()
                });
                
                question.changesCount++;
                question.finalValue = value;
                
                const counter = document.querySelector('#psychQuizContent p');
                if (counter) {
                    counter.innerHTML = `–ò–∑–º–µ–Ω–µ–Ω–∏–π: ${question.changesCount}`;
                }
            });
        });
        
        document.getElementById('psychPrevBtn').disabled = false;
    }

    function psychCompleteSession() {
        let totalChanges = 0;
        let totalQuestions = 0;
        
        gloxSessionState.surveys.forEach(survey => {
            survey.questions.forEach(q => {
                totalChanges += q.changesCount;
                totalQuestions++;
            });
        });
        
        gloxSessionState.metrics.instability = Math.min(100, (totalChanges / totalQuestions) * 20);
        gloxSessionState.metrics.clarificationDepth = totalChanges;
        
        const timeSpent = (Date.now() - gloxSessionState.startedAt) / 1000;
        const timePenalty = timeSpent < 30 ? 10 : 0;
        
        let confidence = 100 - (gloxSessionState.metrics.instability * 0.6) - timePenalty;
        gloxSessionState.metrics.confidence = Math.min(95, Math.max(40, Math.round(confidence)));
        
        let xDelta = 0, yDelta = 0;
        gloxSessionState.surveys.forEach(survey => {
            survey.questions.forEach(q => {
                if (q.finalValue !== null && q.answersHistory.length > 0) {
                    const lastAnswer = q.answersHistory[q.answersHistory.length - 1];
                    xDelta += lastAnswer.impact.xDelta;
                    yDelta += lastAnswer.impact.yDelta;
                }
            });
        });
        
        let finalX = gloxSessionState.baseCoordinates.x + xDelta;
        let finalY = gloxSessionState.baseCoordinates.y + yDelta;
        
        gloxSessionState.baseCoordinates.x = Math.min(10, Math.max(-10, finalX));
        gloxSessionState.baseCoordinates.y = Math.min(10, Math.max(-10, finalY));
        gloxSessionState.finishedAt = Date.now();
        
        document.getElementById('psychQuizScreen').classList.remove('active');
        document.getElementById('psychResultsScreen').classList.add('active');
        
        const x = gloxSessionState.baseCoordinates.x.toFixed(1);
        const y = gloxSessionState.baseCoordinates.y.toFixed(1);
        const tension = Math.abs(gloxSessionState.baseCoordinates.y - gloxSessionState.baseCoordinates.x).toFixed(1);
        
        document.getElementById('finalX').textContent = x;
        document.getElementById('finalY').textContent = y;
        document.getElementById('tensionIndex').textContent = tension;
        document.getElementById('confidenceValue').textContent = gloxSessionState.metrics.confidence + '%';
        document.getElementById('instabilityValue').textContent = Math.round(gloxSessionState.metrics.instability) + '%';
        document.getElementById('clarificationDepth').textContent = gloxSessionState.metrics.clarificationDepth;
        
        let statusHtml = '';
        if (gloxSessionState.metrics.instability > 60) {
            statusHtml += '<div style="background: rgba(244, 67, 54, 0.1); padding: 10px; border-radius: 5px; margin: 5px 0; color: #F44336;"><i class="fas fa-exclamation-triangle"></i> –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ</div>';
        }
        if (gloxSessionState.metrics.confidence > 80) {
            statusHtml += '<div style="background: rgba(76, 175, 80, 0.1); padding: 10px; border-radius: 5px; margin: 5px 0; color: #4CAF50;"><i class="fas fa-check-circle"></i> –ó–∞–º–µ—Ä —É—Å—Ç–æ–π—á–∏–≤</div>';
        }
        if (tension > 5) {
            statusHtml += '<div style="background: rgba(255, 152, 0, 0.1); padding: 10px; border-radius: 5px; margin: 5px 0; color: #FF9800;"><i class="fas fa-balance-scale"></i> –í–æ–∑–º–æ–∂–µ–Ω –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç</div>';
        }
        document.getElementById('statusMessages').innerHTML = statusHtml;
    }

    function updatePsychWidgetDisplay() {
        const content = document.getElementById('psychologicalContent');
        
        if (gloxSessionState.finishedAt) {
            const x = gloxSessionState.baseCoordinates.x.toFixed(1);
            const y = gloxSessionState.baseCoordinates.y.toFixed(1);
            const confidence = gloxSessionState.metrics.confidence;
            
            content.innerHTML = `
                <div style="text-align: center;">
                    <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                        <div>
                            <div style="color: var(--primary); font-size: 1.5rem;">X: ${x}</div>
                            <div style="color: var(--primary); font-size: 1.5rem;">Y: ${y}</div>
                        </div>
                        <div>
                            <div style="color: #4CAF50; font-size: 1.2rem;">${confidence}%</div>
                            <div style="color: var(--text-dim);">—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                        </div>
                    </div>
                    <button class="quiz-btn" id="startPsychologicalBtn" style="width: 100%;">
                        <i class="fas fa-redo"></i> –ü–†–û–ô–¢–ò –ó–ê–ù–û–í–û
                    </button>
                </div>
            `;
            document.getElementById('startPsychologicalBtn').addEventListener('click', startPsychSession);
        }
    }

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    document.addEventListener('DOMContentLoaded', function() {
        initTheme();
        
        // –û—Å–Ω–æ–≤–Ω–æ–π –æ–ø—Ä–æ—Å–Ω–∏–∫
        document.getElementById('mainCircle').addEventListener('click', () => {
            document.getElementById('mainCircle').classList.add('hidden');
            document.getElementById('quizScreen').classList.add('active');
            document.body.style.overflow = 'hidden';
            renderCurrentCategory();
        });
        
        document.getElementById('resultCircle').addEventListener('click', resetQuiz);
        
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentCategoryIndex > 0) {
                currentCategoryIndex--;
                renderCurrentCategory();
            }
        });
        
        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentCategoryIndex < wellBeingQuiz.categories.length - 1) {
                currentCategoryIndex++;
                renderCurrentCategory();
            }
        });
        
        document.getElementById('submitBtn').addEventListener('click', showResults);
        
        document.getElementById('closeResultsBtn').addEventListener('click', () => {
            document.getElementById('resultsScreen').classList.remove('active');
            document.body.style.overflow = 'auto';
            showResultCircle();
        });
        
        document.getElementById('redoQuizBtn').addEventListener('click', resetQuiz);
        
        // –í–∏–¥–∂–µ—Ç—ã
        initTasksWidget();
        initWorldTimeWidget();
        initRecommendationsWidget();
        initPsychologicalWidget();
        initWidgetManager();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
        const saved = sessionStorage.getItem('gloxPsychSession');
        if (saved) {
            Object.assign(gloxSessionState, JSON.parse(saved));
            updatePsychWidgetDisplay();
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            sessionStorage.setItem('gloxPsychSession', JSON.stringify(gloxSessionState));
        });
    });
</script>

</body>
</html>
